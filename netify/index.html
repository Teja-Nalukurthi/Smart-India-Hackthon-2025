<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; color: #333; }
        .container { background-color: #ffffff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); padding: 40px; text-align: center; max-width: 400px; width: 90%; }
        .container.verified { animation: bounceIn 0.6s ease-out forwards; }
        h1 { font-size: 2em; color: #2c3e50; margin-bottom: 15px; }
        p { font-size: 1.1em; color: #7f8c8d; line-height: 1.6; margin-bottom: 25px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; display: block; }
        .icon { font-size: 3em; margin-bottom: 20px; display: block; opacity: 0; transform: scale(0.5); }
        .icon.show { opacity: 1; transform: scale(1); transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div id="status-icon" class="icon"></div>
        <div class="spinner" id="loading-spinner"></div>
        <h1 id="message-title">Verifying your email...</h1>
        <p id="message-body">Please wait a moment while we confirm your account.</p>
    </div>

    <script>
        // TODO: Load these from environment variables in production
        const SUPABASE_URL = process.env.SUPABASE_URL || 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = process.env.SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const mainContainer = document.getElementById('main-container');
        const statusIcon = document.getElementById('status-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const messageTitle = document.getElementById('message-title');
        const messageBody = document.getElementById('message-body');

        function updateUI(status, title, body, icon = '') {
            loadingSpinner.style.display = 'none';
            statusIcon.textContent = icon;
            statusIcon.classList.add('show');
            messageTitle.textContent = title;
            messageBody.textContent = body;
            mainContainer.classList.add('verified');
            if (status === 'success') {
                statusIcon.classList.add('success');
                messageTitle.classList.add('success');
            } else if (status === 'error') {
                statusIcon.classList.add('error');
                messageTitle.classList.add('error');
            }
        }

        // The main listener that waits for a successful login
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                updateUI('success', 'Email Verified!', 'You can now close this page and return to your app.', '✅');
            }
        });

        // --- NEW CODE TO HANDLE THE "?code=..." LINK ---
        // This part actively looks for the code and exchanges it for a session.
        (async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                try {
                    // Tell supabase to exchange the code for a real session
                    const { error } = await supabase.auth.exchangeCodeForSession(code);
                    if (error) {
                        throw error;
                    }
                    // The onAuthStateChange listener above will now handle the SIGNED_IN event
                } catch (error) {
                    // If the exchange fails, show an error
                    updateUI('error', 'Verification Failed', 'This link may be invalid or expired. Please try signing up again.', '❌');
                }
            } else {
                 // Fallback for links that might not have a code, or have already been used
                 setTimeout(() => {
                    const session = supabase.auth.getSession();
                    if (!session && !mainContainer.classList.contains('verified')) {
                         updateUI('error', 'Verification Issue', 'No verification code found in the link. Please try again.', '⚠️');
                    }
                }, 3000);
            }
        })();
        // --- END OF NEW CODE ---
    </script>
</body>
</html>